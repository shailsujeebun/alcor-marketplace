import type {
  ActivityType,
  Brand,
  Category,
  ChatMessage,
  City,
  Company,
  CompanyReview,
  Conversation,
  Country,
  CreateBrandPayload,
  CreateConversationPayload,
  CreateCompanyPayload,
  CreateDealerLeadPayload,
  CreateListingPayload,
  CreateReviewPayload,
  CreateTicketPayload,
  DealerLead,
  Favorite,
  Listing,
  Marketplace,
  PaginatedResponse,
  ReplyTicketPayload,
  SendMessagePayload,
  SupportTicket,
  TicketMessage,
  UpdateDealerLeadPayload,
  UpdateListingPayload,
  UpdateProfilePayload,
  UpdateTicketPayload,
  User,
  ViewHistoryItem,
} from '@/types/api';
import { useAuthStore } from '@/stores/auth-store';
import { refreshTokens } from '@/lib/auth-api';

const API_BASE = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3000';
type GuestUploadTokenResponse = { token: string; expiresIn: number };
let guestUploadTokenCache: { token: string; expiresAt: number } | null = null;

async function tryRefreshToken(): Promise<string | null> {
  try {
    const result = await refreshTokens();
    useAuthStore.getState().setAuth(result.user, result.accessToken);
    return result.accessToken;
  } catch {
    useAuthStore.getState().logout();
    return null;
  }
}

async function getGuestUploadToken(): Promise<string> {
  const now = Date.now();
  if (guestUploadTokenCache && guestUploadTokenCache.expiresAt > now + 5000) {
    return guestUploadTokenCache.token;
  }

  const res = await fetch(`${API_BASE}/upload/guest-token`, {
    method: 'POST',
  });

  if (!res.ok) {
    let detail = '';
    try {
      const body = await res.json();
      detail = body.message || JSON.stringify(body);
    } catch { /* empty */ }
    throw new Error(detail || `Guest upload token error: ${res.status}`);
  }

  const body = (await res.json()) as Partial<GuestUploadTokenResponse>;
  if (!body.token || typeof body.token !== 'string') {
    throw new Error('Guest upload token response is invalid');
  }

  const expiresIn = typeof body.expiresIn === 'number' ? body.expiresIn : 900;
  guestUploadTokenCache = {
    token: body.token,
    expiresAt: now + Math.max(60, expiresIn) * 1000,
  };
  return body.token;
}

async function fetchApi<T>(path: string, init?: RequestInit): Promise<T> {
  const token = useAuthStore.getState().accessToken;
  const headers: Record<string, string> = {
    'Content-Type': 'application/json',
    ...(init?.headers as Record<string, string>),
  };
  if (token) {
    headers['Authorization'] = `Bearer ${token}`;
  }

  let res = await fetch(`${API_BASE}${path}`, { ...init, headers });

  // If 401, try refreshing the token and retry once
  if (res.status === 401) {
    const newToken = await tryRefreshToken();
    if (newToken) {
      headers['Authorization'] = `Bearer ${newToken}`;
      res = await fetch(`${API_BASE}${path}`, { ...init, headers });
    }
  }

  if (!res.ok) {
    let detail = '';
    try {
      const body = await res.json();
      detail = body.message || JSON.stringify(body);
    } catch { /* empty */ }
    throw new Error(detail || `API error: ${res.status}`);
  }
  return res.json();
}

// Listings
export const getListings = (params?: URLSearchParams) =>
  fetchApi<PaginatedResponse<Listing>>(`/listings?${params?.toString() ?? ''}`);

export const getListingById = (id: string) =>
  fetchApi<Listing>(`/listings/${id}`);

export const getCompanyListings = (companyId: string, params?: URLSearchParams) =>
  fetchApi<PaginatedResponse<Listing>>(`/companies/${companyId}/listings?${params?.toString() ?? ''}`);

// Companies
export const getCompanies = (params?: URLSearchParams) =>
  fetchApi<PaginatedResponse<Company>>(`/companies?${params?.toString() ?? ''}`);

export const getCompanyBySlug = (slug: string) =>
  fetchApi<Company>(`/companies/${slug}`);

export const createCompany = (data: CreateCompanyPayload) =>
  fetchApi<Company>('/companies', {
    method: 'POST',
    body: JSON.stringify(data),
  });

export const getCompanyReviews = (companyId: string, params?: URLSearchParams) =>
  fetchApi<PaginatedResponse<CompanyReview>>(`/companies/${companyId}/reviews?${params?.toString() ?? ''}`);

export const createCompanyReview = (companyId: string, data: CreateReviewPayload) =>
  fetchApi<CompanyReview>(`/companies/${companyId}/reviews`, {
    method: 'POST',
    body: JSON.stringify(data),
  });

// Listing status actions
export const submitListing = (id: string) =>
  fetchApi<Listing>(`/listings/${id}/submit`, { method: 'POST' });

export const approveListing = (id: string) =>
  fetchApi<Listing>(`/listings/${id}/approve`, { method: 'POST' });

export const rejectListing = (id: string, moderationReason: string) =>
  fetchApi<Listing>(`/listings/${id}/reject`, {
    method: 'POST',
    body: JSON.stringify({ status: 'REJECTED', moderationReason }),
  });

export const pauseListing = (id: string) =>
  fetchApi<Listing>(`/listings/${id}/pause`, { method: 'POST' });

export const resumeListing = (id: string) =>
  fetchApi<Listing>(`/listings/${id}/resume`, { method: 'POST' });

export const resubmitListing = (id: string) =>
  fetchApi<Listing>(`/listings/${id}/resubmit`, { method: 'POST' });

// Dealer Leads
export const createDealerLead = (data: CreateDealerLeadPayload) =>
  fetchApi<DealerLead>('/dealer-leads', {
    method: 'POST',
    body: JSON.stringify(data),
  });

export const getDealerLeads = (params?: URLSearchParams) =>
  fetchApi<PaginatedResponse<DealerLead>>(`/dealer-leads?${params?.toString() ?? ''}`);

export const getDealerLeadById = (id: string) =>
  fetchApi<DealerLead>(`/dealer-leads/${id}`);

export const updateDealerLead = (id: string, data: UpdateDealerLeadPayload) =>
  fetchApi<DealerLead>(`/dealer-leads/${id}`, {
    method: 'PATCH',
    body: JSON.stringify(data),
  });

// Listing CRUD
export const createListing = (data: CreateListingPayload) =>
  fetchApi<Listing>('/listings', {
    method: 'POST',
    body: JSON.stringify(data),
  });

export const updateListing = (id: string, data: UpdateListingPayload) =>
  fetchApi<Listing>(`/listings/${id}`, {
    method: 'PATCH',
    body: JSON.stringify(data),
  });

// File Upload
export async function uploadImages(files: File[]): Promise<{ urls: string[] }> {
  let token = useAuthStore.getState().accessToken;
  const formData = new FormData();
  files.forEach((file) => formData.append('files', file));
  const headers: Record<string, string> = {};

  if (token) {
    headers.Authorization = `Bearer ${token}`;
  } else {
    headers['x-upload-token'] = await getGuestUploadToken();
  }

  let res = await fetch(`${API_BASE}/upload/images`, {
    method: 'POST',
    headers,
    body: formData,
  });

  // If 401, try refreshing the token and retry once
  if (res.status === 401) {
    const newToken = await tryRefreshToken();
    if (newToken) {
      token = newToken;
      const retryFormData = new FormData();
      files.forEach((file) => retryFormData.append('files', file));
      res = await fetch(`${API_BASE}/upload/images`, {
        method: 'POST',
        headers: { Authorization: `Bearer ${token}` },
        body: retryFormData,
      });
    } else if (!token) {
      guestUploadTokenCache = null;
      const retryFormData = new FormData();
      files.forEach((file) => retryFormData.append('files', file));
      res = await fetch(`${API_BASE}/upload/images`, {
        method: 'POST',
        headers: { 'x-upload-token': await getGuestUploadToken() },
        body: retryFormData,
      });
    }
  }

  if (!res.ok) {
    let detail = '';
    try {
      const body = await res.json();
      detail = body.message || JSON.stringify(body);
    } catch { /* empty */ }
    throw new Error(detail || `Upload error: ${res.status}`);
  }
  return res.json();
}

// Profile
export const updateProfile = (data: UpdateProfilePayload) =>
  fetchApi<User>('/users/me', {
    method: 'PATCH',
    body: JSON.stringify(data),
  });

// ─── Favorites ─────────────────────────────────────
export const addFavorite = (listingId: string) =>
  fetchApi<Favorite>(`/favorites/${listingId}`, { method: 'POST' });

export const removeFavorite = (listingId: string) =>
  fetchApi<void>(`/favorites/${listingId}`, { method: 'DELETE' });

export const getFavorites = (params?: URLSearchParams) =>
  fetchApi<PaginatedResponse<Favorite>>(`/favorites?${params?.toString() ?? ''}`);

export const checkFavorite = (listingId: string) =>
  fetchApi<{ isFavorite: boolean }>(`/favorites/check/${listingId}`);

// ─── View History ──────────────────────────────────
export const recordView = (listingId: string) =>
  fetchApi<ViewHistoryItem>(`/view-history/${listingId}`, { method: 'POST' });

export const getViewHistory = (params?: URLSearchParams) =>
  fetchApi<PaginatedResponse<ViewHistoryItem>>(`/view-history?${params?.toString() ?? ''}`);

// ─── Messages ──────────────────────────────────────
export const startConversation = (data: CreateConversationPayload) =>
  fetchApi<Conversation>('/messages/conversations', {
    method: 'POST',
    body: JSON.stringify(data),
  });

export const getConversations = (params?: URLSearchParams) =>
  fetchApi<PaginatedResponse<Conversation>>(`/messages/conversations?${params?.toString() ?? ''}`);

export const getConversation = (id: string) =>
  fetchApi<Conversation>(`/messages/conversations/${id}`);

export const sendMessage = (conversationId: string, data: SendMessagePayload) =>
  fetchApi<ChatMessage>(`/messages/conversations/${conversationId}`, {
    method: 'POST',
    body: JSON.stringify(data),
  });

export const getUnreadCount = () =>
  fetchApi<{ count: number }>('/messages/unread-count');

// ─── Support ───────────────────────────────────────
export const createTicket = (data: CreateTicketPayload) =>
  fetchApi<SupportTicket>('/support/tickets', {
    method: 'POST',
    body: JSON.stringify(data),
  });

export const getMyTickets = (params?: URLSearchParams) =>
  fetchApi<PaginatedResponse<SupportTicket>>(`/support/tickets?${params?.toString() ?? ''}`);

export const getAllTickets = (params?: URLSearchParams) =>
  fetchApi<PaginatedResponse<SupportTicket>>(`/support/tickets/all?${params?.toString() ?? ''}`);

export const getTicket = (id: string) =>
  fetchApi<SupportTicket>(`/support/tickets/${id}`);

export const replyToTicket = (id: string, data: ReplyTicketPayload) =>
  fetchApi<TicketMessage>(`/support/tickets/${id}/reply`, {
    method: 'POST',
    body: JSON.stringify(data),
  });

export const updateTicket = (id: string, data: UpdateTicketPayload) =>
  fetchApi<SupportTicket>(`/support/tickets/${id}`, {
    method: 'PATCH',
    body: JSON.stringify(data),
  });

// ─── Admin ────────────────────────────────────────

export interface AdminStats {
  usersCount: number;
  listingsCount: number;
  companiesCount: number;
  activeTicketsCount: number;
}

export const getAdminStats = () =>
  fetchApi<AdminStats>('/admin/stats');

export const getUsers = (params?: URLSearchParams) =>
  fetchApi<PaginatedResponse<User>>(`/users?${params?.toString() ?? ''}`);

export const updateUser = (userId: string, data: { role?: string; status?: string }) =>
  fetchApi<User>(`/users/${userId}`, {
    method: 'PATCH',
    body: JSON.stringify(data),
  });

// ─── Admin Company Management ─────────────────────

export const verifyCompany = (id: string) =>
  fetchApi<Company>(`/companies/${id}/verify`, { method: 'PATCH' });

export const updateCompanyFlags = (id: string, data: { isOfficialDealer?: boolean; isManufacturer?: boolean }) =>
  fetchApi<Company>(`/companies/${id}/flags`, {
    method: 'PATCH',
    body: JSON.stringify(data),
  });

export const deleteCompany = (id: string) =>
  fetchApi<void>(`/companies/${id}`, { method: 'DELETE' });

export const deleteReview = (companyId: string, reviewId: string) =>
  fetchApi<void>(`/companies/${companyId}/reviews/${reviewId}`, { method: 'DELETE' });

export const removeListing = (id: string) =>
  fetchApi<Listing>(`/listings/${id}/remove`, { method: 'POST' });

export const deleteConversation = (id: string) =>
  fetchApi<void>(`/messages/conversations/${id}`, { method: 'DELETE' });

// ─── Admin Messages Oversight ─────────────────────

export const getAllConversations = (params?: URLSearchParams) =>
  fetchApi<PaginatedResponse<Conversation>>(`/messages/conversations/all?${params?.toString() ?? ''}`);

export const getConversationAdmin = (id: string) =>
  fetchApi<Conversation>(`/messages/conversations/${id}/admin`);

// ─── Notifications ────────────────────────────────

export const getNotifications = (params?: URLSearchParams) =>
  fetchApi<PaginatedResponse<import('@/types/api').Notification>>(`/notifications?${params?.toString() ?? ''}`);

export const getNotificationUnreadCount = () =>
  fetchApi<{ count: number }>('/notifications/unread-count');

export const markNotificationRead = (id: string) =>
  fetchApi<void>(`/notifications/${id}/read`, { method: 'PATCH' });

export const markAllNotificationsRead = () =>
  fetchApi<void>('/notifications/read-all', { method: 'POST' });

// ─── Saved Searches ───────────────────────────────

export const getSavedSearches = () =>
  fetchApi<import('@/types/api').SavedSearch[]>('/saved-searches');

export const createSavedSearch = (data: { name: string; filters: Record<string, string> }) =>
  fetchApi<import('@/types/api').SavedSearch>('/saved-searches', {
    method: 'POST',
    body: JSON.stringify(data),
  });

export const deleteSavedSearch = (id: string) =>
  fetchApi<void>(`/saved-searches/${id}`, { method: 'DELETE' });

// ─── Plans & Subscriptions ─────────────────────────

export const getPlans = () =>
  fetchApi<import('@/types/api').Plan[]>('/plans');

export const getMySubscription = () =>
  fetchApi<import('@/types/api').Subscription | null>('/subscriptions/me');

// Reference data
export const getMarketplaces = () => fetchApi<Marketplace[]>('/marketplaces');
export const getCategories = (marketplaceId?: string) =>
  fetchApi<Category[]>(`/categories${marketplaceId ? `?marketplaceId=${marketplaceId}` : ''}`);
export const getBrands = (categoryId?: string) =>
  fetchApi<Brand[]>(`/brands${categoryId ? `?categoryId=${categoryId}` : ''}`);
export const createBrand = (data: CreateBrandPayload) =>
  fetchApi<Brand>('/brands', {
    method: 'POST',
    body: JSON.stringify(data),
  });
export const getCountries = () => fetchApi<Country[]>('/countries');
export const getCities = (countryId?: string) =>
  fetchApi<PaginatedResponse<City>>(`/cities${countryId ? `?countryId=${countryId}` : ''}`);
export const getActivityTypes = () => fetchApi<ActivityType[]>('/activity-types');

// ─── Search & Filters ──────────────────────────────

export interface SearchResponse {
  data: Listing[];
  meta: {
    total: number;
    page: number;
    limit: number;
    totalPages: number;
  };
}

export interface FacetsResponse {
  categories: Array<{ id: string; name: string; count: number }>;
  brands: Array<{ id: string; name: string; count: number }>;
  priceRange?: { min: number; max: number };
  yearRange?: { min: number; max: number };
}

export const searchListings = (params?: URLSearchParams) =>
  fetchApi<SearchResponse>(`/search?${params?.toString() ?? ''}`);

export const getSearchFacets = (params?: URLSearchParams) =>
  fetchApi<FacetsResponse>(`/search/facets?${params?.toString() ?? ''}`);

// ─── Dynamic Forms ─────────────────────────────────

export interface FormTemplate {
  id: string;
  categoryId: string;
  version: number;
  fields: FormField[];
}

export interface FormField {
  id: string;
  key: string;
  label: string;
  type: 'TEXT' | 'NUMBER' | 'SELECT' | 'MULTISELECT' | 'BOOLEAN' | 'RADIO' | 'CHECKBOX_GROUP' | 'DATE' | 'YEAR_RANGE' | 'COLOR' | 'LOCATION' | 'MEDIA' | 'RICHTEXT' | 'PRICE';
  isRequired: boolean;
  section?: string;
  validationRules?: Record<string, any>;
  options?: FieldOption[];
}

export interface FieldOption {
  id: string;
  value: string;
  label: string;
}

export interface ValidateDraftPayload {
  categoryId: string;
  attributes: Array<{ key: string; value: string }>;
}

export interface ValidationResponse {
  valid: boolean;
  errors?: Array<{ field: string; message: string }>;
}

export const getCategoryTemplate = (categoryId: string) =>
  fetchApi<FormTemplate>(`/categories/${categoryId}/template`);

export const validateListingDraft = (data: ValidateDraftPayload) =>
  fetchApi<ValidationResponse>('/listings/draft/validate', {
    method: 'POST',
    body: JSON.stringify(data),
  });

export const updateListingAttributes = (id: string, attributes: Array<{ key: string; value: string }>) =>
  fetchApi<Listing>(`/listings/${id}/attributes`, {
    method: 'PUT',
    body: JSON.stringify({ attributes }),
  });

// ─── Contact Management ────────────────────────────

export interface ContactPayload {
  name: string;
  email: string;
  phoneCountry?: string;
  phoneNumber?: string;
}

export const updateListingContact = (id: string, data: ContactPayload) =>
  fetchApi<Listing>(`/listings/${id}/contact`, {
    method: 'PUT',
    body: JSON.stringify(data),
  });

// ─── Presigned Upload ──────────────────────────────

export interface PresignedUploadResponse {
  uploadUrl: string;
  key: string;
  publicUrl: string;
}

export const getPresignedUploadUrl = () =>
  fetchApi<PresignedUploadResponse>('/upload/presigned');

export const uploadToS3 = async (presignedUrl: string, file: File): Promise<void> => {
  const res = await fetch(presignedUrl, {
    method: 'PUT',
    body: file,
    headers: { 'Content-Type': file.type },
  });
  if (!res.ok) {
    throw new Error(`S3 upload failed: ${res.status}`);
  }
};

// ─── Admin Marketplaces & Categories ────────────────

export interface AdminMarketplace {
  id: number;
  key: string;
  name: string;
  isActive: boolean;
}

export interface AdminCategory {
  id: number;
  marketplaceId: number;
  name: string;
  slug: string;
  parentId?: number;
  sortOrder?: number;
  hasEngine?: boolean;
  children?: AdminCategory[];
}

export const getAdminMarketplaces = () =>
  fetchApi<AdminMarketplace[]>('/admin/marketplaces');

export const createAdminMarketplace = (data: { key: string; name: string }) =>
  fetchApi<AdminMarketplace>('/admin/marketplaces', {
    method: 'POST',
    body: JSON.stringify(data),
  });

export const updateAdminMarketplace = (id: number, data: { name?: string; isActive?: boolean }) =>
  fetchApi<AdminMarketplace>(`/admin/marketplaces/${id}`, {
    method: 'PATCH',
    body: JSON.stringify(data),
  });

export const createAdminCategory = (data: {
  marketplaceId: number;
  name: string;
  slug: string;
  parentId?: number;
  sortOrder?: number;
  hasEngine?: boolean;
}) =>
  fetchApi<AdminCategory>('/admin/categories', {
    method: 'POST',
    body: JSON.stringify(data),
  });

export const updateAdminCategory = (id: number, data: {
  name?: string;
  slug?: string;
  parentId?: number;
  sortOrder?: number;
  hasEngine?: boolean;
}) =>
  fetchApi<AdminCategory>(`/admin/categories/${id}`, {
    method: 'PATCH',
    body: JSON.stringify(data),
  });

export const deleteAdminCategory = (id: number) =>
  fetchApi<void>(`/admin/categories/${id}`, { method: 'DELETE' });

export const getAdminTemplates = () =>
  fetchApi<import('@/types/api').AdminTemplate[]>('/admin/templates');

export const createAdminTemplate = (data: { categoryId: number; name?: string; fields: any[] }) =>
  fetchApi<FormTemplate>('/admin/templates', {
    method: 'POST',
    body: JSON.stringify(data),
  });

export const updateAdminTemplate = (id: number, data: { fields: any[] }) =>
  fetchApi<FormTemplate>(`/admin/templates/${id}`, {
    method: 'PATCH',
    body: JSON.stringify(data),
  });

export const getAdminTemplate = (id: number) =>
  fetchApi<FormTemplate>(`/admin/templates/${id}`);

export const deleteAdminTemplate = (id: number) =>
  fetchApi<void>(`/admin/templates/${id}`, { method: 'DELETE' });

export const updateAdminTemplateStatus = (id: number, isActive: boolean) =>
  fetchApi<import('@/types/api').AdminTemplate>(`/admin/templates/${id}/status`, {
    method: 'PATCH',
    body: JSON.stringify({ isActive }),
  });

export const getCategoryTemplateByCategory = (categoryId: number) =>
  fetchApi<FormTemplate | null>(`/categories/${categoryId}/template`).catch(() => null);

