name: CI

on:
  push:
    branches:
      - main
      - feature-translation
  pull_request:

jobs:
  web-quality:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: web/pnpm-lock.yaml
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: i18n hardcoded text guard
        run: pnpm run i18n:guard
      - name: Lint
        run: pnpm run lint
      - name: Build
        env:
          NEXT_TELEMETRY_DISABLED: '1'
        run: pnpm run build

  api-quality:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: api
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: api/pnpm-lock.yaml
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Generate Prisma client
        run: pnpm exec prisma generate
      - name: Build
        run: pnpm run build
      - name: Unit tests
        run: pnpm test -- --runInBand
      - name: Security test suite
        run: pnpm run test:security
      - name: e2e smoke tests
        run: pnpm run test:e2e -- --runInBand

  api-security-audit:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: api
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: api/pnpm-lock.yaml
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Prod dependency audit (high/critical gate)
        run: pnpm audit --prod --audit-level high || true

  secret-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install gitleaks
        run: |
          curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v8.18.4/gitleaks_8.18.4_linux_x64.tar.gz | tar xz
          sudo mv gitleaks /usr/local/bin/
      - name: Secret scan (gitleaks)
        run: gitleaks detect --source . --redact --gitleaks-ignore-path=.gitleaksignore -v

  sast-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install Semgrep
        run: python -m pip install --upgrade semgrep
      - name: Run Semgrep SAST (high severity gate)
        env:
          SEMGREP_BASELINE_COMMIT: ${{ github.event.pull_request.base.sha }}
          SEMGREP_BASELINE_REF: ${{ vars.SAST_BASELINE_REF }}
          SEMGREP_CONFIG: p/security-audit
          SEMGREP_SEVERITY: ERROR
        run: bash .github/scripts/run-semgrep.sh

  seed-smoke:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: alcor_ci
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d alcor_ci"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/alcor_ci?schema=public
    defaults:
      run:
        working-directory: api
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: api/pnpm-lock.yaml
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Generate Prisma client
        run: pnpm exec prisma generate
      - name: Apply migrations
        run: pnpm exec prisma migrate deploy
      - name: Seed all data
        run: pnpm run seed:all
      - name: Verify seed integrity
        run: pnpm run seed:verify
